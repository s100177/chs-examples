# 分层分布式控制（Hierarchical Distributed Control）示例

本示例旨在演示一种先进的分层分布式控制架构，用于复杂的水力系统（如输水运河）的智能管理。该架构结合了上层全局优化与下层局部精确控制的优点。

## 核心架构

本示例采用两层控制结构：

1.  **上层：中心MPC（模型预测控制）智能体 (`CentralMPCAgent`)**
    *   **角色**: 作为系统的“大脑”，负责全局优化。
    *   **工作原理**: 该智能体监控整个运河系统的关键状态（如此示例中的两个主要渠道段的水位）。基于一个系统的预测模型，它计算出能在未来一段时间内（预测时域）维持系统稳定并满足需求的**最优水位目标**（setpoints）。
    *   **通信**: 它并不直接控制物理设备（如闸门），而是将计算出的最优水位目标通过消息总线（Message Bus）发布到指定的课题（topics）上。

2.  **下层：本地PID控制智能体 (`StructuredControlAgent`)**
    *   **角色**: 作为系统的“执行单元”，负责精确、快速地执行上层下发的指令。
    *   **工作原理**: 每个关键物理节点（如此示例中的两个闸门）都由一个本地PID智能体控制。这些智能体订阅中心MPC智能体发布的水位目标课题。一旦收到新的水位目标，它会将其作为PID控制器的动态设定点（dynamic setpoint）。随后，它会持续比较本地传感器的实际读数（实际水位）与这个动态目标，并通过PID算法计算出精确的闸门开度，以消除误差。
    *   **优势**: 这种方式使得本地控制非常快速和有弹性，能够即时响应局部扰动，同时其控制目标又能服务于全局最优。

## 数据驱动与智能体模式

*   **智能体化**: 系统中的每个决策单元（MPC控制器、PID控制器）都被封装为独立的智能体，它们通过消息总线进行异步通信，高度解耦，易于扩展和维护。
*   **数据驱动**: 控制决策完全基于从系统中流转的数据（水位、流量等）。中心MPC智能体根据全局数据进行宏观决策，本地PID智能体根据局部数据和上层指令进行微观执行。

## 如何运行示例

请确保您已安装所有必要的依赖项。从代码库的根目录执行以下命令：

```bash
python run_scenario.py examples/canal_model/hierarchical_distributed_control_example/
```

该命令会调用根目录下的通用场景运行器 `run_scenario.py`，并将其指向本示例的配置文件夹。

## 预期结果

模拟运行后，将在 `examples/canal_model/hierarchical_distributed_control_example/` 目录下生成一个 `output.yml` 文件。您可以分析此文件来观察系统的动态行为。

特别关注以下几点：

1.  **`control/canal_1/setpoint` 和 `control/canal_2/setpoint` 的消息**: 查看这些课题下的消息记录，您会发现其 `value` （即水位设定点）会由 `central_mpc_controller` 在每个控制间隔（本例中为300秒）进行更新。
2.  **`actuator/gate_1/opening` 和 `actuator/gate_2/opening` 的消息**: 观察由 `gate1_pid_controller` 和 `gate2_pid_controller` 发送的闸门开度指令。
3.  **`sensor/canal_1/water_level` 和 `sensor/canal_2/water_level` 的状态**: 比较这两个渠道的实际水位历史记录与MPC下发的目标，可以看到PID控制器是如何努力跟踪动态设定点的。
4.  **扰动影响**: 在模拟的第3600秒和5400秒，`scenario_agent` 会引入需水变化。观察系统是如何通过分层控制架构平稳地适应这些扰动的。
