# 有压系统仿真与控制说明文档

本文档旨在指导用户如何基于 SWP 平台框架，构建一个包含有压管道、阀站、泵站、水电站等复杂组件的仿真系统。任务的核心是拆解各个组件的最小功能单元，通过一系列由小及大的例子，最终实现一个完整的分层分布式控制与多设备协同调度系统。

## 1. 最小单元独立示例

在这一部分，我们将分别展示每个新增核心组件的功能和相关智能体的作用，使其在最简单的环境中独立运行。

### 示例 1.1：有压管道与阀站本体仿真

**目标**：演示有压管道（Pipe）和阀门（Valve）的物理动态行为，以及它们对水头损失和流量的影响。

**任务**：

1.  初始化一个 `Reservoir`（作为水源）、一个 `Pipe` 和一个 `Valve` 物理组件。
2.  在仿真循环中，手动设定一个恒定的上游水头和一个变化的下游水头，模拟阀门的开度变化。
3.  调用 `pipe.step()` 和 `valve.step()` 方法。
4.  验证 `Pipe` 中的出流量如何随水头差和阀门开度变化，并记录产生的摩擦水头损失。

**核心功能点**：展示达西-韦斯巴赫方程（Darcy-Weisbach equation）在有压管道中的应用，以及阀门过流曲线对流量的影响。

### 示例 1.2：泵站多机组协同控制

**目标**：展示如何通过一个智能体控制一个泵站中的多个水泵机组，以实现流量的精确控制。

**任务**：

1.  初始化一个包含多个 `Pump` 物理组件的 `PumpStation` 对象。
2.  创建一个 `PumpControlAgent`，它订阅一个“流量需求”主题，并发布“水泵启停指令”。
3.  在仿真循环中，模拟一个阶跃变化的流量需求，并手动将该需求发布给 `PumpControlAgent`。
4.  验证 `PumpControlAgent` 是否能根据需求的变化，智能地决定开启或关闭不同数量的水泵机组，以尽可能接近目标流量。

**核心功能点**：展示多设备协同控制逻辑，将离散的启停动作转化为对连续目标的响应。

### 示例 1.3：水电站多设备联合调度

**目标**：展示一个水电站智能体如何平衡多个目标（发电、泄洪、供水）和多个设备（水轮机、泄洪闸、供水闸）之间的关系。

**任务**：

1.  初始化一个 `Reservoir`、多个 `WaterTurbine`、一个 `FloodGate` 和一个 `SupplyGate`。
2.  创建一个 `HydropowerStationAgent`，它同时监听水库水位和下游电力需求。
3.  模拟一个上游来水突然增加的情景。
4.  在仿真循环中，验证 `HydropowerStationAgent` 是否能优先考虑防洪，关闭水轮机，并开启泄洪闸以降低水位，同时仍尝试满足最低供水需求。

**核心功能点**：展示多目标（如发电与防洪）下的决策优先级和复杂设备（水轮机和闸门）的联合调度。

### 示例 1.4：数据清洗与评价诊断

**目标**：展示如何使用数据处理模块对不完美的数据进行清洗，并使用评价模块对模型性能进行量化诊断。

**任务**：

1.  创建一个带有缺失值（NaN）和异常值的模拟时间序列数据。
2.  使用 `core_lib.data_processing.cleaner.fill_missing_with_interpolation` 函数对数据进行清洗。
3.  创建一个模拟的“真值”数据序列。
4.  使用 `core_lib.data_processing.evaluator` 模块中的 `calculate_rmse`, `calculate_nse`, `calculate_kge` 函数，对清洗后的数据与真值进行对比，并打印出评价指标。

**核心功能点**：展示平台在数据质量管理和模型性能诊断方面的基础能力。

### 示例 1.5：预测预警

**目标**：展示预测智能体如何利用历史数据进行预测，并据此发出预警。

**任务**：

1.  创建一个 `ForecastingAgent`（例如 `ARIMAForecaster` 或 `LSTMFlowForecaster`）。
2.  为其提供一个包含有规律趋势或周期性的历史数据序列。
3.  调用 `ForecastingAgent` 的预测方法（例如 `_forecast()`）。
4.  验证预测结果是否合理，并设计一个简单的逻辑：如果预测结果超过某个阈值，则向消息总线发布一个“预警”消息。

**核心功能点**：体现智能体系统的“前瞻性”，即在事件发生之前进行预判和预警。

### 示例 1.6：系统辨识

**目标**：展示 `ParameterIdentificationAgent` 如何通过观测数据自动校准模型参数。

**任务**：

1.  初始化一个带有“错误”初始参数的物理模型（例如 `RainfallRunoff` 模型）。
2.  创建 `ParameterIdentificationAgent`，并为其提供一组包含“真值”的输入输出数据（例如，降雨数据和对应的径流观测数据）。
3.  运行 `ParameterIdentificationAgent` 的 `run()` 方法，使其触发参数辨识过程。
4.  验证模型的参数（例如，径流系数）是否被校准到了接近真实值的水平。

**核心功能点**：展示平台“自我学习”和“自适应”的能力，确保数字孪生模型随现实变化而更新。

## 2. 组合与分层示例

在这一部分，我们将把上述最小单元组合起来，构建一个完整的、可运行的分层分布式系统。

### 示例 2.1：有压输水管网闭环控制

**目标**：构建一个从泵站到下游水库的有压输水管网系统，并实现自动控制。

**任务**：

1.  将示例 1.1 和 1.2 的组件（`PumpStation`、`Pipe`、`Valve`）与 `Reservoir` 物理模型结合。
2.  `PressureSensorAgent` 监测管道压力。`PumpControlAgent` 根据压力调整泵机组的启停。
3.  验证系统在应对下游用水需求变化时，能否通过泵站的智能控制来维持稳定的管道压力。

**核心功能点**：展示有压管道网络的感知-控制闭环，确保系统安全稳定运行。

### 示例 2.2：流域水资源联合调度

**目标**：构建一个包含水电站和下游分水口的复杂流域系统，实现多目标联合调度。

**任务**：

1.  整合所有物理组件，包括水电站中的 `WaterTurbine`、`Gate` 等，以及下游的渠道和分水口。
2.  部署多个智能体：`HydropowerStationAgent` 负责发电，`WaterUseAgent` 负责模拟分水口需求，`CentralDispatcher` 则负责全局协调。
3.  模拟一场洪水和下游用水高峰期同时发生的极端情况。
4.  验证所有智能体如何协同工作：`HydropowerStationAgent` 优先泄洪，`CentralDispatcher` 重新分配下游用水，确保整个流域的安全。

**核心功能点**：这是最终极的复杂示例，它将全面验证多智能体系统在应对极端复杂情景时的联合调度和决策能力。

---

通过遵循这个分步提示词，您可以逐一理解并验证每个组件的功能，最终实现一个复杂且健壮的智能水利仿真系统。
