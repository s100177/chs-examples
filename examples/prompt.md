任务描述：构建径流式水电站分层调度与联合控制仿真系统
请根据提供的平台框架，构建一个包含有6台贯流式水轮机和5个泄洪闸的径流式水电站仿真系统。本任务的核心是拆解各个组件的最小功能单元，并通过一系列由小及大的例子，最终实现一个完整的分层分布式控制与多设备联合调度系统。

把这个提示词，写到示例程序所在的目录，方便进行分析理解

1. 总体目标
实时响应与稳定控制：系统需实时响应上游来水和坝前水位的变化，通过智能调度水轮机和泄洪闸，确保坝前水位稳定在安全范围内。

电网交互：模拟与电网的实时交互，上报更新的发电出力计划，并根据电网的接受或拒绝情况调整策略。

安全冗余：将泄洪闸作为“最后一层安全防线”，在水轮机出力和电网互动无法完全平衡来水时，实时定制闸门启闭指令以维持坝前水位稳定。

物理约束考虑：在调度时，必须考虑下游河道水位顶托对水轮机发电出力的影响。

多设备协同与优化：实现泄洪闸门和水轮机组的流量分配策略表和站内经济运行策略表，以在多设备之间进行联合优化调度。

2. 系统拓扑与物理组件
请构建以下拓扑结构，并使用更精确的物理模型：

上游来水 -> 坝前河道 (Forebay River Reach) -> (6台水轮机) / (5个泄洪闸) -> 下游河道 (Tailrace)

物理组件：

forebay_river_reach：模拟水电站坝前水库，其物理模型应采用高保真瞬态水力学模型来精细模拟水位动态。其水位是核心控制目标。

water_turbine_1 - water_turbine_6：6台贯流式水轮机，用于发电。

spillway_gate_1 - spillway_gate_5：5个泄洪闸，作为最后的泄洪手段。

tailrace_river_reach：模拟下游河道。其水位会随下泄流量变化，产生顶托效应。

扰动源：

上游来水：来自上游电站调峰调频，导致日内流量变化剧烈。

下游顶托：下游河道水位因下泄流量变化而动态变化，对水电站出力的物理约束。

3. 智能体组件与功能
请为上述物理系统配置以下智能体，并确保它们通过 MessageBus 协同工作：

感知层（数字孪生）：

forebay_twin_agent：监测并发布 forebay_river_reach 的实时水位。

tailrace_twin_agent：监测并发布 tailrace_river_reach 的下游水位，以供顶托效应的计算和调度决策。

预测层：

inflow_forecaster：预测上游来水的日内变化趋势，并将预测结果发送给中心调度器。

扰动层：

upstream_inflow_agent：模拟上游电站调峰导致的突发性、非计划性来水扰动。

控制层（分层分布式）：

central_dispatcher：中心MPC智能体。它订阅所有关键状态（坝前水位、下游水位）和预测信息。其MPC优化算法采用积分时滞零点（IDZ）降阶模型，以在保证计算效率的同时，精确预测系统动态。它计算出最优的联合调度策略，并以总发电量目标和总泄洪流量目标的形式，将高层指令发送给现地控制器。

hydropower_control_agent：现地PID智能体。它接收中心MPC的总发电量目标，并根据站内经济运行策略表，实时计算并执行对6台水轮机的联合出力指令，以实现最佳经济效益。

spillway_control_agent：现地PID智能体。它接收中心MPC的总泄洪流量目标，并根据流量分配策略表，实时计算和执行对5个泄洪闸的启闭指令，以维持坝前水位稳定。

外部系统交互：

grid_communication_agent：模拟与电网的互动。它接收中心调度的发电计划，模拟发送给电网，并发布电网的响应（接受/拒绝）。

4. 泄洪与发电的流量分配策略
为了实现多设备间的智能协同，需要为现地控制智能体提供以下预先计算好的策略表：

泄洪闸门流量分配策略表：

目的：根据总泄洪流量目标和当前上下游水位，决定5个泄洪闸的最佳开度组合。此策略的首要目标是泄洪安全，其次是避免不必要的闸门频繁调节。

规则：这是一个预先生成的查找表或一组严格的逻辑规则。例如：当总流量较小时，只开启1-2个闸门；当流量增大时，为了泄洪安全，必须根据水位和流量严格按照顺序和开度组合开启更多闸门。

水轮机组站内经济运行策略表：

目的：根据总发电出力目标和当前水头情况，决定6台水轮机组的最佳开机组合和出力分配。

规则：这是一个预先通过复杂优化程序计算生成的查找表。它会考虑每台水轮机在不同水头和出力下的效率曲线，以找到一个最优的组合，在满足总出力需求的同时，最大限度地提高发电效率，从而实现经济运行。在应用时，现地智能体只需根据中心MPC发出的总出力目标和实时物理状态，直接查表即可获得最优的机组组合和分配方案。

5. 仿真工作流与分步示例
请拆解成最小单元的独立示例，然后再逐一组合，实现完整功能。

示例 5.1：水轮机与泄洪闸本体仿真
目标：独立演示单个水轮机和泄洪闸的物理行为，以及下游顶托的影响。

任务：

初始化一个 WaterTurbine 和一个 Gate 物理组件，并配置下游水位动态变化。

手动改变水轮机的过流流量和下游水位。

验证水轮机的出力如何因下游顶托而变化。

核心功能点：展示水电站物理模型对水头和流量变化的响应，特别要验证顶托对出力的影响。

示例 5.2：水轮机多设备协同与电网交互
目标：展示 HydropowerControlAgent 如何协调多台水轮机，并与电网进行通信。

任务：

构建一个包含6台水轮机的系统。

创建 HydropowerControlAgent 和 GridCommunicationAgent。

在仿真中，模拟一个发电目标。验证 HydropowerControlAgent 是否能通过合理分配启停机组，实现发电目标。

模拟电网拒绝部分发电计划，验证 HydropowerControlAgent 如何调整机组组合以满足新的约束。

核心功能点：展示多设备调度和与外部系统交互的逻辑。

示例 5.3：计算站内经济运行策略表
目标：编写一个程序，提前计算并生成水电站的站内经济运行策略表。

任务：

定义6台水轮机各自的效率曲线（例如，使用分段函数或查表法）。

定义一个优化函数，其目标是在给定总发电出力和上下游水头的情况下，最小化总泄洪量或最大化总发电效率。

遍历不同的总出力目标和水头组合，为每个组合运行优化算法（例如，一个穷举搜索或非线性规划），找到最优的机组开机和出力分配方案。

将结果存储为一张查找表（例如，一个字典或pandas DataFrame），以便在实时仿真中快速查询。

核心功能点：展示如何通过预计算来将复杂的实时优化问题转化为高效的查表问题，这是实现实时经济运行的关键。

示例 5.4：计算泄洪闸流量分配表
目标：编写一个程序，提前计算并生成泄洪闸的流量分配策略表，以确保泄洪安全。

任务：

定义5个泄洪闸的过流曲线（即流量与开度、水头的关系）。

定义一套严格的泄洪安全规则，例如：水位低于XX米时，泄洪闸不开；当水位高于XX米且总流量超过YY时，应优先开启1号和2号闸门，并保持开度一致，以防偏流。

遍历不同的总泄洪流量目标和上下游水头组合，根据安全规则计算出闸门的启闭和开度组合。

将结果存储为一张查找表，在应用时，现地智能体只需根据中心MPC发出的总泄洪目标和实时物理状态，直接查表即可获得安全的闸门启闭指令。

核心功能点：体现“安全第一”原则，通过预计算将复杂决策转化为可快速执行的安全指令。

示例 5.5：中心MPC对泄洪发电的联合调度
目标：构建一个完整的系统，演示中心MPC智能体如何在面对突发来水时，对泄洪和发电进行联合优化。

任务：

整合所有物理组件和所有智能体。

upstream_inflow_agent 注入一个模拟上游来水突然增加的扰动。

分层决策：

中心MPC接收预测和实时坝前水位，利用其IDZ降阶模型预测不同控制策略下的系统响应，并计算出最优的泄洪和发电组合，然后发出指令。

HydropowerControlAgent 和 SpillwayControlAgent 接收指令，并实时调整水轮机和闸门的运行状态。

验证系统在优先保证坝前水位安全的前提下，如何尽可能地利用水能发电。

核心功能点：这是最终极的复杂示例，它将全面验证多智能体分层联合调度在应对极端复杂情景时的决策能力。

6. 参数配置建议
仿真参数：duration=14400s（4小时），dt=10s。

水轮机参数：efficiency (0.9), max_flow_rate (50 m³/s), rated_head (10m)。

中心调度器 MPC 配置：

forebay_level_setpoint: 15.0m

forebay_level_threshold: 16.0m（触发应急泄洪）

prediction_horizon: 60（预测10分钟）

q_weight: 1.0（水位偏离目标的成本）

power_weight: 0.5（发电收益的权重）

r_weight: 0.1（控制动作变化的成本）
