# 案例二：水箱出口系数参数辨识

## 1. 案例目标

本案例旨在演示如何使用**孪生智能体（Twin Agent）** 和**水库智能体（Reservoir Agent）** 来辨识一个未知的水箱物理参数——出口阀的流量系数（`outlet_coeff`）。

- **水库智能体**: 扮演一个“真实”的物理水箱。它的出口系数是一个我们假装不知道的“真实值”。它负责根据输入（进水流量）生成可观测的输出（水位）。
- **孪生智能体**: 扮演一个数字孪生模型。它拥有和真实水箱完全一样的数学模型，但其出口系数是一个可调整的变量。它的目标是通过不断观察真实水箱的水位，并与自己的仿真结果进行比较，来动态调整自身的出口系数，最终使其收敛到真实值。

## 2. 文件结构

- `main.py`: 参数辨识过程的主入口程序。它负责初始化两个智能体，并在一个循环中驱动它们交互，直到辨识过程结束。
- `reservoir_agent.py`: 定义了 `ReservoirAgent` 类，代表“真实”的物理系统。
- `twin_agent.py`: 定义了 `TwinAgent` 类，它包含了参数辨识的核心逻辑。
- `config.json`: 配置文件。定义了真实水箱的（未知）参数、孪生模型的初始参数、辨识算法的参数（如学习率）等。
- `README.md`: 本说明文档。

## 3. 辨识原理

1.  **初始化**:
    -   水库智能体的出口系数被设为一个“真实”值（例如 `0.8`）。
    -   孪生智能体的出口系数被设为一个初始猜测值（例如 `0.2`），这个值与真实值有较大差距。

2.  **迭代辨识**: 仿真在多个时间步上循环进行：
    -   在每个时间步，两个智能体接收到**完全相同**的进水流量 `Q_in`。
    -   水库智能体根据其**真实**的出口系数计算其水位 `h_real`。
    -   孪生智能体根据其**当前估计**的出口系数计算其水位 `h_twin`。
    -   孪生智能体计算其预测水位与真实水位的误差 `error = h_twin - h_real`。
    -   根据误差，孪生智能体调整其出口系数。调整策略是：
        -   如果 `error > 0`（孪生水位偏高），说明其模型中的出流量太小，需要**增大**出口系数。
        -   如果 `error < 0`（孪生水位偏低），说明其模型中的出流量太大，需要**减小**出口系数。
    -   调整的幅度由一个**学习率（learning_rate）** 控制。

3.  **收敛**: 随着时间的推移，孪生智能体的出口系数会逐渐逼近水库智能体的真实系数。

为了让辨识效果更好，本案例的 `config.json` 中使用了一个动态变化的进水流量模式（`inflow_pattern`），而不是一个恒定的值。这有助于更充分地激发系统的动态特性，使得辨识结果更准确。

## 4. 如何运行

1.  在 `02_parameter_identification` 目录下，直接运行主程序：

    ```bash
    python main.py
    ```

2.  程序会首先打印出真实的系数和孪生模型的初始猜测系数。
3.  辨识过程结束后，程序会打印出最终辨识出的系数，并通知日志文件已保存。
4.  结果保存在 `examples/watertank/logs/02_parameter_identification/identification_log.csv` 文件中。你可以通过分析这个文件来观察辨识收敛的过程，例如，查看 `estimated_coeff` 列如何随 `time` 变化并逼近真实值。

## 5. 如何配置

通过修改 `config.json` 文件来探索不同的辨识场景：

- `reservoir_params`:
  - `outlet_coeff`: 改变这个值来设定不同的“真实”目标。
- `twin_params`:
  - `initial_outlet_coeff`: 从不同的初始猜测值开始辨识。
- `identification_params`:
  - `learning_rate`: 调整学习率。太大的学习率可能导致振荡，太小则收敛缓慢。
- `simulation_params`:
  - `inflow_pattern`: 设计不同的进水模式来观察其对辨识效果的影响。
