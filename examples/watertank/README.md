# 水箱仿真示例说明

本项目包含一系列水箱（水库）的仿真和控制示例，旨在演示本仿真平台的核心功能和架构思想。

## 示例的两种运行方式

本目录下的示例反映了两种不同的架构和运行方式：

### 1. 脚本式仿真 (Script-based)

- **适用示例**: `02` 到 `07`
- **运行方式**: 每个示例目录下都有一个 `main.py` 文件，可直接通过 `python` 命令运行。
  ```bash
  # 以案例03为例
  python examples/watertank/03_pid_control_inlet/main.py
  ```
- **特点**: 这种方式将仿真环境的搭建、智能体的初始化和仿真循环全部封装在一个Python脚本中。它非常适合用于逻辑简单、组件较少的教学或验证性示例，代码逻辑清晰直观。

### 2. 场景驱动式仿真 (Scenario-driven)

- **适用示例**: `01_simulation` (已重构)
- **运行方式**: 这种方式使用项目根目录下的 `run_scenario.py` 脚本作为统一的启动器，通过命令行参数指定场景目录。
  ```bash
  python run_scenario.py examples/watertank/01_simulation
  ```
- **特点**: 这是平台**推荐的标准方式**，特别适用于构建包含多个物理组件和智能体的复杂系统。它将系统的定义和代码逻辑完全分离，实现了高度的模块化和可重用性。

---

## 场景驱动式仿真的核心原理

场景驱动的运行方式背后是`SimulationHarness`（仿真测试平台）在起作用。您可以将其理解为一个“**仿真裁判**”或“**游戏引擎**”。它的核心思想是**分离关注点**：

- **物理世界(What)**: 系统中有什么物理实体（水库、管道、阀门等）？这由 `components.yml` 文件定义。
- **物理拓扑(Where)**: 这些实体是如何连接的（例如，A水库的水流向B管道）？这由 `topology.yml` 文件定义。
- **智能体(Who)**: 系统中有哪些“玩家”（感知智能体、控制智能体、数据注入智能体等）？它们观察什么、决策什么？这由 `agents.yml` 文件定义。
- **全局配置(How)**: 仿真运行多久、步长是多大？这由 `config.yml` 文件定义。

`SimulationHarness` 在启动时会读取所有这些配置文件，像搭积木一样将整个系统“组装”起来，然后在每个时间步，它会：
1.  **驱动智能体**: 调用所有智能体的`.run()`方法，让它们完成感知、决策和发布指令。
2.  **驱动物理世界**: 根据物理拓扑顺序，依次调用所有物理组件的`.step()`方法，计算并更新它们的状态。

这种声明式的、由配置驱动的架构，使得修改系统变得非常简单（例如，增加一个水库或替换一个控制算法），通常只需要修改YAML文件，而无需触及代码。

### 配置文件详解 (以案例01为例)

#### `config.yml`
定义全局仿真参数。
- `simulation.duration`: 仿真总时长。
- `simulation.dt`: 每个仿真步的时间间隔。

#### `components.yml`
定义系统中的所有物理组件。
- `id`: 组件的唯一标识符。
- `class`: 组件对应的Python类名（例如 `Reservoir`）。
- `inflow_topic`: (可选) 如果该组件的入流由消息总线提供，在这里指定主题。
- `initial_state`: 定义组件的初始状态（如初始水位`water_level`、初始库容`volume`）。
- `parameters`: 定义组件的物理参数（如表面积`surface_area`）。

#### `topology.yml`
定义组件间的物理连接关系。
- `connections`: 一个连接列表，每个连接包含`upstream`（上游组件ID）和`downstream`（下游组件ID）。
- 对于只有一个组件的系统，此列表为空。

#### `agents.yml`
定义系统中的所有智能体。
- `id`: 智能体的唯一标识符。
- `class`: 智能体对应的Python类名（例如 `CsvInflowAgent`）。
- `config`: 一个字典，包含该智能体初始化所需的所有参数。
  - `target_component_id`: 对于数据注入类智能体，指定其作用的目标组件。
  - `csv_file`: CSV数据文件的路径（相对于场景目录）。

---

## 各示例功能概览

- **01_simulation**: [场景驱动] 基础的水箱仿真，由CSV文件提供恒定的入流。
- **02_parameter_identification**: [脚本式] 参数辨识，通过一个孪生智能体在线辨识“真实”水库的出口系数。
- **03_pid_control_inlet**: [脚本式] PID控制，当出水存在扰动时，通过控制进水泵来稳定水位。
- **04_pid_control_outlet**: [脚本式] PID控制，当进水存在扰动时，通过控制出水阀来稳定水位。
- **05_joint_control**: [脚本式] 联合控制，通过一个协调器智能体，同时调度进水泵和出水阀来对抗扰动、稳定水位。
- **06_sensor_disturbance**: [脚本式] 传感器扰动，模拟水位传感器存在测量噪声时，对PID控制稳定性的影响。
- **07_actuator_disturbance**: [脚本式] 执行器扰动，模拟水泵执行器存在偏差和噪声，无法完美执行控制指令时，对系统造成的影响。
