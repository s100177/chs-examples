## 04 - PID出口控制 (PID Outlet Control)

### 问题描述 (Problem Description)

本案例与 `03_pid_control_inlet` 互为镜像。系统的目标同样是维持水库水位在10.0米，但这次的控制手段是调节**出口阀门**的开度，而入口流量则作为一种不可控的外部扰动。

这种控制方式在实际中也很常见，例如通过控制大坝的泄洪闸门来稳定上游水位。此案例旨在检验PID控制器在“反向作用”（即增加阀门开度导致水位下降）的回路中的性能。

### 实现思路 (Implementation)

*   **物理拓扑 (topology.yml):**
    ```yaml
    connections:
      - upstream: reservoir_1
        downstream: valve_1
    ```
    与之前的案例不同，这里我们明确定义了 `reservoir_1` 和 `valve_1` 之间的物理连接。这使得水库的出流量 `outflow` 直接由下游阀门的状态决定。

*   **智能体配置 (agents.yml):**
    1.  `CsvInflowAgent`: 作为“扰动”智能体，从 `inflow_disturbance.csv` 文件中读取一个变化的入口流量，并将其发布到 `inflow_disturbance_topic`。水库组件订阅此主题。
    2.  `DigitalTwinAgent`: 感知水库的 `water_level` 并将其发布到 `water_level_topic`。
    3.  `LocalControlAgent` (PID): 订阅 `water_level_topic`，将其与10.0米的目标值比较，计算出阀门开度（0-100%），并发布到 `valve_command_topic`。阀门组件订阅此主题以接收控制指令。
    4.  `TopicLoggerAgent`: 配置了两个记录器，分别记录入口扰动流量和阀门控制指令，用于后续分析。

### 关键技术 (Key Technologies)

*   **反向作用PID控制 (Reverse-Acting PID Control)**: 当水位高于目标时，控制器需要增加输出（阀门开度）以增加出流量，从而降低水位。这与入口控制（增加输出导致水位上升）相反。本案例中的PID控制器通过使用**正增益**（Kp, Ki, Kd > 0）来正确处理这种关系。
*   **物理拓扑连接**: 展示了如何在CHS-SDK中定义组件之间的物理连接，以及这种连接如何影响系统状态的计算（例如，水库的出流量现在由阀门决定）。

### 仿真结果与分析 (Simulation Results & Analysis)

#### 动态过程展示 (Dynamic Process)
![Simulation Results](simulation_results.gif)

#### 关键指标总结 (Key Performance Indicators)
| 指标 (Metric) | 数值 (Value) |
|---|---|
| 水库最高水位 (m) | 417.56 |
| 水库最低水位 (m) | 13.11 |
| 水库平均水位 (m) | 222.21 |
| 水位控制均方根误差 (RMSE) | 243.9047 |

#### 结果分析与讨论 (Analysis & Discussion)
从动图和指标可以看出，当前PID控制器的性能非常差，系统完全处于失控状态。
1.  **失控的水位 (上图)**: 仿真开始时，水位为12.0米，高于10.0米的目标值。PID控制器正确地增加了阀门开度（下图绿线）以尝试降低水位。然而，入口的扰动流量（下图紫线）远大于阀门所能排出的流量，导致水库水位几乎是**无限制地持续上升**，最终在300秒时达到了惊人的417米。
2.  **控制饱和 (下图)**: PID控制器在检测到巨大误差后，迅速将其输出增加到最大值100%，即阀门全开。然而，即使阀门全开，其出流量也远不足以抵消入口的扰动流量，因此控制动作饱和，失去了对系统的控制能力。

这个结果暴露了当前系统设计的根本性问题：**执行器能力不足**。出口阀门的物理参数（直径、流量系数）决定了其最大排水能力，当入口流量长时间超过这个能力时，无论控制器如何动作，系统都必然会溢出。

### 建议与展望 (Suggestions & Outlook)

*   **重新设计物理系统**: 为了实现有效控制，必须确保执行器（阀门）的能力与可能的扰动范围相匹配。可以尝试增加阀门的直径或数量。
*   **增加告警机制**: 在现实世界中，当控制器长时间饱和且误差持续增大时，应触发告警。可以设计一个`SupervisoryAgent`（监控智能体）来监测这种情况并发出警报。
*   **引入前馈控制**: 除了PID反馈控制外，可以增加一个前馈环节。如果入口流量可以被测量，那么可以将该测量值直接送到控制器，提前调整阀门开度，以更快地应对扰动。
